<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Minha Equipe</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #e4fbe6, #ffffff);
      margin: 0;
      padding: 20px;
      color: #222;
      animation: fadeIn 0.8s ease-in-out;
    }

    .logo {
      display: block;
      margin: 0 auto 10px auto;
      max-width: 120px;
      animation: zoomIn 0.5s ease;
    }

    h2 {
      text-align: center;
      color: #137c33;
      margin-bottom: 10px;
    }

    #info {
      text-align: center;
      margin-bottom: 20px;
      color: #444;
      font-size: 17px;
    }

    .convite-box {
      background-color: #eaffea;
      padding: 10px;
      border-radius: 8px;
      display: inline-block;
      font-weight: bold;
      word-break: break-word;
      margin-top: 10px;
    }

    .copy-btn {
      display: inline-block;
      margin-top: 8px;
      padding: 6px 12px;
      background-color: #137c33;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      animation: slideUp 0.6s ease;
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }

    th {
      background-color: #137c33;
      color: white;
    }

    tr:hover {
      background-color: #f1f1f1;
    }

    .info-comissao {
      margin-top: 20px;
      text-align: center;
      font-size: 15px;
      background-color: #ecfcec;
      border-left: 4px solid #137c33;
      padding: 10px 15px;
      border-radius: 5px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      color: #2b2b2b;
    }

    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity: 1;}
    }

    @keyframes slideUp {
      from {transform: translateY(20px); opacity: 0;}
      to {transform: translateY(0); opacity: 1;}
    }

    @keyframes zoomIn {
      from {transform: scale(0.8); opacity: 0;}
      to {transform: scale(1); opacity: 1;}
    }
  </style>
</head>
<body>

  <img src="logo.png" alt="Smart Invest" class="logo" />

  <h2>Convidados Diretos</h2>
  <div id="info">
    <div id="total">Total de convidados diretos: 0</div>
    <div id="comissaoTotal">Comissão total: 0 Kz</div>
    <div>Link de convite:</div>
    <div class="convite-box" id="linkConvite">Carregando...</div><br/>
    <button class="copy-btn" onclick="copiarLink()">Copiar link</button>
  </div>

  <table id="tabelaConvidados">
    <thead>
      <tr>
        <th>#</th>
        <th>Nome</th>
        <th>Telefone</th>
        <th>Valor Investido</th>
        <th>Comissão (32%)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="info-comissao">
    Para ganhar comissões, compartilhe seu link de convite com amigos. <br/>
    Sempre que um convidado direto fizer um investimento, você ganha automaticamente <strong>32%</strong> do valor investido como comissão.<br/>
    Convide mais pessoas para aumentar seus ganhos!
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, get, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyChrog4zZNoK8HTMl1MTMD43U7HHxBMtVw",
      authDomain: "palpite3ad.firebaseapp.com",
      databaseURL: "https://palpite3ad-default-rtdb.firebaseio.com",
      projectId: "palpite3ad",
      storageBucket: "palpite3ad.appspot.com",
      messagingSenderId: "435372004187",
      appId: "1:435372004187:android:3b7ee8b621fba094b2407e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    onAuthStateChanged(auth, user => {
      if (!user) {
        alert("Sessão expirada. Faça login novamente.");
        window.location.href = "index.html";
        return;
      }

      const uid = user.uid;
      const conviteCurto = uid.slice(-6); // pega os últimos 6 caracteres do UID
      const link = `${window.location.origin}/login.index.html?ref=${conviteCurto}`;
      document.getElementById("linkConvite").textContent = link;

      const usuariosRef = ref(db, "usuarios");
      const tabela = document.querySelector("#tabelaConvidados tbody");
      const totalDiv = document.getElementById("total");
      const comissaoDiv = document.getElementById("comissaoTotal");

      onValue(usuariosRef, snapshot => {
        const dados = snapshot.val();
        tabela.innerHTML = "";

        let totalConvidados = 0;
        let totalComissao = 0;
        let index = 1;

        Object.entries(dados).forEach(([uidConvidado, info]) => {
          if (info.convidadoPor && info.convidadoPor.endsWith(conviteCurto)) {
            totalConvidados++;

            let valorInvestido = 0;
            let comissaoIndividual = 0;

            if (info.investimentos) {
              Object.entries(info.investimentos).forEach(([idInvest, invest]) => {
                const preco = parseInt(invest.preco || 0);
                if (invest.status === "ativo") {
                  valorInvestido += preco;
                  const comissao = Math.floor(preco * 0.32);
                  comissaoIndividual += comissao;

                  if (!invest.comissaoPaga) {
                    totalComissao += comissao;
                    get(ref(db, `usuarios/${uid}/saldo`)).then(snap => {
                      const saldoAtual = snap.exists() ? parseInt(snap.val()) : 0;
                      update(ref(db, `usuarios/${uid}`), {
                        saldo: saldoAtual + comissao
                      });
                    });
                    update(ref(db, `usuarios/${uidConvidado}/investimentos/${idInvest}`), {
                      comissaoPaga: true
                    });
                  } else {
                    totalComissao += comissao;
                  }
                }
              });
            }

            tabela.innerHTML += `
              <tr>
                <td>${index++}</td>
                <td>${info.nome || "Sem nome"}</td>
                <td>${info.telefone || "-"}</td>
                <td>${valorInvestido} Kz</td>
                <td>${comissaoIndividual} Kz</td>
              </tr>`;
          }
        });

        totalDiv.textContent = `Total de convidados diretos: ${totalConvidados}`;
        comissaoDiv.textContent = `Comissão total: ${totalComissao} Kz`;
      });
    });

    window.copiarLink = function () {
      const texto = document.getElementById("linkConvite").textContent;
      navigator.clipboard.writeText(texto).then(() => {
        alert("Link copiado com sucesso!");
      });
    };
  </script>
</body>
</html>
